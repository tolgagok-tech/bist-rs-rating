import yfinance as yf
import pandas as pd
import numpy as np
import time

# --- DOSYADAKİ TÜM (1000+) SEMBOLLER ---
semboller = [
    "A", "AA", "AAL", "AAON", "AAPL", "ABBV", "ABNB", "ABT", "ACGL", "ACHC", "ACI", "ACM", "ACN", "ADBE", "ADC", "ADI", "ADM", "ADP", "ADSK", "ADT", "AEE", "AEP", "AES", "AFG", "AFL", "AFRM", "AGCO", "AGNC", "AGO", "AIG", "AIT", "AIZ", "AJG", "AKAM", "AL", "ALAB", "ALB", "ALGM", "ALGN", "ALK", "ALL", "ALLE", "ALLY", "ALNY", "ALSN", "AM", "AMAT", "AMCR", "AMD", "AME", "AMG", "AMGN", "AMH", "AMKR", "AMP", "AMT", "AMTM", "AMZN", "AN", "ANET", "AON", "AOS", "APA", "APD", "APG", "APH", "APLS", "APO", "APP", "APPF", "APTV", "AR", "ARE", "ARES", "ARMK", "ARW", "AS", "ASH", "ASTS", "ATI", "ATO", "ATR", "AU", "AUR", "AVB", "AVGO", "AVT", "AVTR", "AVY", "AWI", "AWK", "AXON", "AXP", "AXS", "AXTA", "AYI", "AZO", "BA", "BAC", "BAH", "BALL", "BAM", "BAX", "BBWI", "BBY", "BC", "BDX", "BEN", "BERY", "BF-B", "BGC", "BHF", "BIGZ", "BIIB", "BILL", "BIO", "BK", "BKNG", "BLD", "BLK", "BMY", "BOC", "BOOT", "BORR", "BOX", "BP", "BR", "BRKR", "BRO", "BRX", "BSX", "BSY", "BURL", "BWA", "BWXT", "BX", "BXP", "BYD", "C", "CABO", "CACC", "CACI", "CADE", "CAG", "CAH", "CAR", "CARR", "CAT", "CB", "CBOE", "CBRE", "CBSH", "CC", "CCK", "CCL", "CDNS", "CDRE", "CDW", "CE", "CEG", "CELH", "CENX", "CF", "CFG", "CFLT", "CFR", "CHDN", "CHE", "CHH", "CHRW", "CHT", "CHTR", "CI", "CINF", "CIEN", "CINT", "CIO", "CIX", "CL", "CLH", "CLX", "CMA", "CMCSA", "CME", "CMG", "CMI", "CMS", "CNA", "CNC", "CNP", "CNX", "COF", "COHR", "COIN", "COLB", "COLM", "CONE", "COO", "COP", "COR", "COST", "COTY", "CPB", "CPNG", "CPRT", "CPT", "CR", "CRBG", "CRL", "CRM", "CRSP", "CRWD", "CSCO", "CSL", "CSX", "CTAS", "CTRA", "CTSH", "CTVA", "CUBE", "CUK", "CVNA", "CVS", "CVX", "CW", "CWH", "CZR", "D", "DAL", "DAN", "DAR", "DASH", "DAY", "DBI", "DBX", "DCI", "DD", "DDOG", "DE", "DECK", "DEI", "DELL", "DFS", "DG", "DGX", "DHI", "DHR", "DIS", "DKS", "DLB", "DLR", "DLTR", "DOC", "DOCS", "DOCU", "DOV", "DOW", "DPZ", "DRI", "DT", "DTE", "DUK", "DVA", "DVN", "DXCM", "DXP", "EAT", "EBAY", "ECL", "ED", "EFX", "EG", "EGP", "EGRX", "EH", "EIX", "EL", "ELAN", "ELF", "ELV", "EMN", "EMR", "ENOV", "ENPH", "ENTG", "EOG", "EPAM", "EPC", "EPR", "EQH", "EQIX", "EQR", "EQT", "ERIE", "ES", "ESI", "ESS", "ETN", "ETR", "ETSY", "EVR", "EVRG", "EW", "EXAS", "EXC", "EXEL", "EXK", "EXP", "EXPD", "EXPE", "EXR", "F", "FAF", "FANG", "FAST", "FATE", "FBC", "FBIN", "FCN", "FCX", "FDS", "FDX", "FE", "FHN", "FICO", "FIS", "FISV", "FITB", "FIVE", "FIVN", "FL", "FLEX", "FLO", "FLS", "FLT", "FMC", "FMS", "FNB", "FND", "FNF", "FNV", "FOR", "FOUR", "FOX", "FOXA", "FPH", "FPI", "FR", "FRT", "FSLR", "FTI", "FTNT", "FTV", "FUBO", "FUL", "FVRR", "G", "GD", "GDDY", "GE", "GEHC", "GEN", "GEV", "GFI", "GFL", "GFS", "GGB", "GGG", "GHC", "GHM", "GIB", "GILD", "GIS", "GL", "GLPI", "GLW", "GM", "GME", "GMED", "GNRC", "GNTX", "GOOG", "GOOGL", "GPC", "GPK", "GPN", "GRMN", "GS", "GSL", "GWRE", "H", "HAL", "HAS", "HAYW", "HBI", "HCA", "HCP", "HD", "HDB", "HE", "HEI", "HES", "HIG", "HII", "HIMS", "HIW", "HL", "HLT", "HMA", "HMC", "HMN", "HMY", "HOG", "HOLX", "HON", "HPE", "HPP", "HPQ", "HRB", "HRL", "HSIC", "HST", "HSY", "HTA", "HTZ", "HUBB", "HUM", "HUN", "HWM", "HZNP", "IBM", "ICE", "ICLR", "IDXX", "IEX", "IFF", "ILMN", "INCY", "INFY", "ING", "INTC", "INTU", "INVH", "IONQ", "IP", "IPG", "IQV", "IR", "IRM", "ISRG", "IT", "ITW", "IVZ", "JBHT", "JBL", "JBLU", "JCI", "JD", "JEF", "JKHY", "JLL", "JNJ", "JNPR", "JPM", "JWN", "K", "KDP", "KEY", "KEYS", "KHC", "KIM", "KKR", "KLAC", "KMB", "KMI", "KMX", "KO", "KOLD", "KR", "KSS", "KSU", "L", "LAD", "LAMR", "LANC", "LAZ", "LBRDA", "LBRDK", "LCID", "LDOS", "LEN", "LFUS", "LH", "LHX", "LIN", "LITB", "LKQ", "LLY", "LMT", "LNC", "LND", "LNN", "LNT", "LOW", "LPLA", "LRCX", "LULU", "LUV", "LVS", "LW", "LYB", "LYFT", "LYV", "M", "MA", "MAA", "MAR", "MAS", "MASI", "MAT", "MCD", "MCHP", "MCK", "MCO", "MDLZ", "MDT", "MET", "META", "MGM", "MHK", "MIK", "MKTX", "MLM", "MMC", "MMM", "MNST", "MO", "MODG", "MOH", "MOS", "MPC", "MPWR", "MRK", "MRNA", "MRO", "MRTX", "MRVL", "MS", "MSCI", "MSFT", "MSI", "MTB", "MTCH", "MTD", "MTN", "MU", "MUR", "NCLH", "NDAQ", "NDSN", "NEE", "NEM", "NET", "NEU", "NFE", "NFLX", "NFP", "NI", "NKE", "NKLA", "NLY", "NOC", "NOW", "NRG", "NSC", "NTAP", "NTRS", "NUE", "NVDA", "NVR", "NVST", "NWL", "NWS", "NWSA", "NXPI", "NYCB", "NYT", "O", "ODFL", "OKE", "OKTA", "OLED", "OMC", "ON", "ORCL", "ORLY", "OTIS", "OXY", "PARA", "PAYC", "PAYX", "PBI", "PCAR", "PCG", "PEAK", "PEG", "PENN", "PEP", "PFE", "PFG", "PG", "PGR", "PH", "PHM", "PKG", "PKI", "PLD", "PLTR", "PM", "PNC", "PNFP", "PNR", "PNW", "PODD", "POOL", "POST", "PPC", "PPG", "PPL", "PR", "PRGO", "PRI", "PRMB", "PRU", "PSA", "PSN", "PSTG", "PSX", "PTC", "PVH", "PWR", "PYPL", "Q", "QCOM", "QGEN", "QRVO", "QS", "QSR", "QXO", "R", "RAL", "RARE", "RBA", "RBC", "RBLX", "RBRK", "RCL", "RDDT", "REG", "REGN", "REXR", "REYN", "RF", "RGA", "RGEN", "RGLD", "RH", "RHI", "RITM", "RIVN", "RJF", "RKLB", "RKT", "RL", "RLI", "RMD", "RNG", "RNR", "ROIV", "ROK", "ROKU", "ROL", "ROP", "ROST", "RPM", "RPRX", "RRC", "RRX", "RS", "RSG", "RTX", "RVMD", "RVTY", "RYAN", "RYN", "S", "SAIA", "SAIC", "SAIL", "SAM", "SARO", "SBAC", "SBUX", "SCCO", "SCHW", "SCI", "SEB", "SEE", "SEIC", "SF", "SFD", "SFM", "SGI", "SHC", "SHW", "SIRI", "SITE", "SJM", "SLB", "SLG", "SMCI", "SNA", "SNOW", "SNPS", "SO", "SON", "SPG", "SPGI", "SPLK", "SPR", "SRE", "SRPT", "STAG", "STLD", "STT", "STX", "STZ", "SWK", "SWKS", "SYF", "SYK", "SYY", "T", "TAP", "TDG", "TDY", "TEAM", "TECH", "TEL", "TENB", "TER", "TFC", "TFX", "TGT", "TJX", "TKR", "TLO", "TMDX", "TMUS", "TNET", "TOL", "TPR", "TRGP", "TRMB", "TROW", "TRV", "TSCO", "TSLA", "TSN", "TT", "TTD", "TTWO", "TWLO", "TXN", "TXT", "TYL", "U", "UAL", "UBER", "UDR", "UGI", "UHS", "ULTA", "UNH", "UNP", "UPS", "URI", "USB", "V", "VALE", "VEEV", "VFC", "VIAC", "VLO", "VMC", "VNO", "VRSK", "VRSN", "VRT", "VRTX", "VTR", "VTRS", "VZ", "WAB", "WAT", "WBA", "WBD", "WDC", "WEC", "WELL", "WFC", "WHR", "WM", "WMB", "WMT", "WRB", "WST", "WTW", "WY", "WYNN", "XEL", "XOM", "XRAY", "XYL", "YUM", "Z", "ZBH", "ZBRA", "ZIM", "ZM", "ZS", "ZTS", "AEE", "AEP", "AES", "AFG", "AFL", "AFRM", "AGCO", "AGNC", "AGO", "AIG", "AIT", "AIZ", "AJG", "AKAM", "AL", "ALAB", "ALB", "ALGM", "ALGN", "ALK", "ALL", "ALLE", "ALLY", "ALNY", "ALSN", "AM", "AMAT", "AMCR", "AMD", "AME", "AMG", "AMGN", "AMH", "AMKR", "AMP", "AMT", "AMTM", "AMZN", "AN", "ANET", "AON", "AOS", "APA", "APD", "APG", "APH", "APLS", "APO", "APP", "APPF", "APTV", "AR", "ARE", "ARES", "ARMK", "ARW", "AS", "ASH", "ASTS", "ATI", "ATO", "ATR", "AU", "AUR", "AVB", "AVGO", "AVT", "AVTR", "AVY", "AWI", "AWK", "AXON", "AXP", "AXS", "AXTA", "AYI", "AZO", "BA", "BAC", "BAH", "BALL", "BAM", "BAX", "BBWI", "BBY", "BC", "BDX", "BEN", "BERY", "BF-B", "BGC", "BHF", "BIGZ", "BIIB", "BILL", "BIO", "BK", "BKNG", "BLD", "BLK", "BMY", "BOC", "BOOT", "BORR", "BOX", "BP", "BR", "BRKR", "BRO", "BRX", "BSX", "BSY", "BURL", "BWA", "BWXT", "BX", "BXP", "BYD", "C", "CABO", "CACC", "CACI", "CADE", "CAG", "CAH", "CAR", "CARR", "CAT", "CB", "CBOE", "CBRE", "CBSH", "CC", "CCK", "CCL", "CDNS", "CDRE", "CDW", "CE", "CEG", "CELH", "CENX", "CF", "CFG", "CFLT", "CFR", "CHDN", "CHE", "CHH", "CHRW", "CHT", "CHTR", "CI", "CINF", "CIEN", "CINT", "CIO", "CIX", "CL", "CLH", "CLX", "CMA", "CMCSA", "CME", "CMG", "CMI", "CMS", "CNA", "CNC", "CNP", "CNX", "COF", "COHR", "COIN", "COLB", "COLM", "CONE", "COO", "COP", "COR", "COST", "COTY", "CPB", "CPNG", "CPRT", "CPT", "CR", "CRBG", "CRL", "CRM", "CRSP", "CRWD", "CSCO", "CSL", "CSX", "CTAS", "CTRA", "CTSH", "CTVA", "CUBE", "CUK", "CVNA", "CVS", "CVX", "CW", "CWH", "CZR", "D", "DAL", "DAN", "DAR", "DASH", "DAY", "DBI", "DBX", "DCI", "DD", "DDOG", "DE", "DECK", "DEI", "DELL", "DFS", "DG", "DGX", "DHI", "DHR", "DIS", "DKS", "DLB", "DLR", "DLTR", "DOC", "DOCS", "DOCU", "DOV", "DOW", "DPZ", "DRI", "DT", "DTE", "DUK", "DVA", "DVN", "DXCM", "DXP", "EAT", "EBAY", "ECL", "ED", "EFX", "EG", "EGP", "EGRX", "EH", "EIX", "EL", "ELAN", "ELF", "ELV", "EMN", "EMR", "ENOV", "ENPH", "ENTG", "EOG", "EPAM", "EPC", "EPR", "EQH", "EQIX", "EQR", "EQT", "ERIE", "ES", "ESI", "ESS", "ETN", "ETR", "ETSY", "EVR", "EVRG", "EW", "EXAS", "EXC", "EXEL", "EXK", "EXP", "EXPD", "EXPE", "EXR", "F", "FAF", "FANG", "FAST", "FATE", "FBC", "FBIN", "FCN", "FCX", "FDS", "FDX", "FE", "FHN", "FICO", "FIS", "FISV", "FITB", "FIVE", "FIVN", "FL", "FLEX", "FLO", "FLS", "FLT", "FMC", "FMS", "FNB", "FND", "FNF", "FNV", "FOR", "FOUR", "FOX", "FOXA", "FPH", "FPI", "FR", "FRT", "FSLR", "FTI", "FTNT", "FTV", "FUBO", "FUL", "FVRR", "G", "GD", "GDDY", "GE", "GEHC", "GEN", "GEV", "GFI", "GFL", "GFS", "GGB", "GGG", "GHC", "GHM", "GIB", "GILD", "GIS", "GL", "GLPI", "GLW", "GM", "GME", "GMED", "GNRC", "GNTX", "GOOG", "GOOGL", "GPC", "GPK", "GPN", "GRMN", "GS", "GSL", "GWRE", "H", "HAL", "HAS", "HAYW", "HBI", "HCA", "HCP", "HD", "HDB", "HE", "HEI", "HES", "HIG", "HII", "HIMS", "HIW", "HL", "HLT", "HMA", "HMC", "HMN", "HMY", "HOG", "HOLX", "HON", "HPE", "HPP", "HPQ", "HRB", "HRL", "HSIC", "HST", "HSY", "HTA", "HTZ", "HUBB", "HUM", "HUN", "HWM", "HZNP", "IBM", "ICE", "ICLR", "IDXX", "IEX", "IFF", "ILMN", "INCY", "INFY", "ING", "INTC", "INTU", "INVH", "IONQ", "IP", "IPG", "IQV", "IR", "IRM", "ISRG", "IT", "ITW", "IVZ", "JBHT", "JBL", "JBLU", "JCI", "JD", "JEF", "JKHY", "JLL", "JNJ", "JNPR", "JPM", "JWN", "K", "KDP", "KEY", "KEYS", "KHC", "KIM", "KKR", "KLAC", "KMB", "KMI", "KMX", "KO", "KOLD", "KR", "KSS", "KSU", "L", "LAD", "LAMR", "LANC", "LAZ", "LBRDA", "LBRDK", "LCID", "LDOS", "LEN", "LFUS", "LH", "LHX", "LIN", "LITB", "LKQ", "LLY", "LMT", "LNC", "LND", "LNN", "LNT", "LOW", "LPLA", "LRCX", "LULU", "LUV", "LVS", "LW", "LYB", "LYFT", "LYV", "M", "MA", "MAA", "MAR", "MAS", "MASI", "MAT", "MCD", "MCHP", "MCK", "MCO", "MDLZ", "MDT", "MET", "META", "MGM", "MHK", "MIK", "MKTX", "MLM", "MMC", "MMM", "MNST", "MO", "MODG", "MOH", "MOS", "MPC", "MPWR", "MRK", "MRNA", "MRO", "MRTX", "MRVL", "MS", "MSCI", "MSFT", "MSI", "MTB", "MTCH", "MTD", "MTN", "MU", "MUR", "NCLH", "NDAQ", "NDSN", "NEE", "NEM", "NET", "NEU", "NFE", "NFLX", "NFP", "NI", "NKE", "NKLA", "NLY", "NOC", "NOW", "NRG", "NSC", "NTAP", "NTRS", "NUE", "NVDA", "NVR", "NVST", "NWL", "NWS", "NWSA", "NXPI", "NYCB", "NYT", "O", "ODFL", "OKE", "OKTA", "OLED", "OMC", "ON", "ORCL", "ORLY", "OTIS", "OXY", "PARA", "PAYC", "PAYX", "PBI", "PCAR", "PCG", "PEAK", "PEG", "PENN", "PEP", "PFE", "PFG", "PG", "PGR", "PH", "PHM", "PKG", "PKI", "PLD", "PLTR", "PM", "PNC", "PNFP", "PNR", "PNW", "PODD", "POOL", "POST", "PPC", "PPG", "PPL", "PR", "PRGO", "PRI", "PRMB", "PRU", "PSA", "PSN", "PSTG", "PSX", "PTC", "PVH", "PWR", "PYPL", "Q", "QCOM", "QGEN", "QRVO", "QS", "QSR", "QXO", "R", "RAL", "RARE", "RBA", "RBC", "RBLX", "RBRK", "RCL", "RDDT", "REG", "REGN", "REXR", "REYN", "RF", "RGA", "RGEN", "RGLD", "RH", "RHI", "RITM", "RIVN", "RJF", "RKLB", "RKT", "RL", "RLI", "RMD", "RNG", "RNR", "ROIV", "ROK", "ROKU", "ROL", "ROP", "ROST", "RPM", "RPRX", "RRC", "RRX", "RS", "RSG", "RTX", "RVMD", "RVTY", "RYAN", "RYN", "S", "SAIA", "SAIC", "SAIL", "SAM", "SARO", "SBAC", "SBUX", "SCCO", "SCHW", "SCI", "SEB", "SEE", "SEIC", "SF", "SFD", "SFM", "SGI", "SHC", "SHW", "SIRI", "SITE", "SJM", "SLB", "SLG", "SMCI", "SNA", "SNOW", "SNPS", "SO", "SON", "SPG", "SPGI", "SPLK", "SPR", "SRE", "SRPT", "STAG", "STLD", "STT", "STX", "STZ", "SWK", "SWKS", "SYF", "SYK", "SYY", "T", "TAP", "TDG", "TDY", "TEAM", "TECH", "TEL", "TENB", "TER", "TFC", "TFX", "TGT", "TJX", "TKR", "TLO", "TMDX", "TMUS", "TNET", "TOL", "TPR", "TRGP", "TRMB", "TROW", "TRV", "TSCO", "TSLA", "TSN", "TT", "TTD", "TTWO", "TWLO", "TXN", "TXT", "TYL", "U", "UAL", "UBER", "UDR", "UGI", "UHS", "ULTA", "UNH", "UNP", "UPS", "URI", "USB", "V", "VALE", "VEEV", "VFC", "VIAC", "VLO", "VMC", "VNO", "VRSK", "VRSN", "VRT", "VRTX", "VTR", "VTRS", "VZ", "WAB", "WAT", "WBA", "WBD", "WDC", "WEC", "WELL", "WFC", "WHR", "WM", "WMB", "WMT", "WRB", "WST", "WTW", "WY", "WYNN", "XEL", "XOM", "XRAY", "XYL", "YUM", "Z", "ZBH", "ZBRA", "ZIM", "ZM", "ZS", "ZTS"
]

# Tekrar edenleri temizle (bazı dosyalar hata payı içerebilir)
semboller = list(dict.fromkeys(semboller))

def get_price(ticker):
    try:
        data = yf.download(ticker, period="2y", interval="1d", progress=False, auto_adjust=True)
        if data.empty: return None
        if isinstance(data.columns, pd.MultiIndex):
            close = data['Close'][ticker]
        else:
            close = data['Close']
        return close.dropna()
    except: return None

def rs_hesapla(fiyatlar, end_perf_skor):
    if fiyatlar is None or len(fiyatlar) < 252: return None
    try:
        skor = (0.4 * (fiyatlar.iloc[-1] / fiyatlar.iloc[-min(63, len(fiyatlar))])) + \
               (0.2 * (fiyatlar.iloc[-1] / fiyatlar.iloc[-min(126, len(fiyatlar))])) + \
               (0.2 * (fiyatlar.iloc[-1] / fiyatlar.iloc[-min(189, len(fiyatlar))])) + \
               (0.2 * (fiyatlar.iloc[-1] / fiyatlar.iloc[-min(252, len(fiyatlar))]))
        return (float(skor) / end_perf_skor) * 100
    except: return None

# --- ANALİZ ---
print("Endeks (^GSPC) verileri çekiliyor...")
spx_fiyat = get_price("^GSPC")
if spx_fiyat is not None and len(spx_fiyat) >= 252:
    end_perf = (0.4 * (spx_fiyat.iloc[-1] / spx_fiyat.iloc[-63])) + \
               (0.2 * (spx_fiyat.iloc[-1] / spx_fiyat.iloc[-126])) + \
               (0.2 * (spx_fiyat.iloc[-1] / spx_fiyat.iloc[-189])) + \
               (0.2 * (spx_fiyat.iloc[-1] / spx_fiyat.iloc[-252]))
    end_perf = float(end_perf)
else:
    end_perf = 1.0

sonuclar = []
print(f"Başlıyor! Toplam {len(semboller)} benzersiz hisse taranacak...")

for i, s in enumerate(semboller):
    fiyat_serisi = get_price(s)
    if fiyat_serisi is not None:
        rs_val = rs_hesapla(fiyat_serisi, end_perf)
        if rs_val is not None:
            sonuclar.append({'Hisse': s, 'RS_Skoru': round(rs_val, 4)})
    
    if (i + 1) % 50 == 0:
        print(f"İlerleme: {i + 1} / {len(semboller)}")
    
    time.sleep(0.01)

if sonuclar:
    df = pd.DataFrame(sonuclar)
    df['RS_Rating'] = (df['RS_Skoru'].rank(pct=True) * 98 + 1).round(1)
    df = df.sort_values(by='RS_Rating', ascending=False)
    
    print("\n--- ANALİZ SONUÇLARI (ÜST SEGMENT) ---")
    print(df.head(20))
    
    df.to_csv('tüm_hisseler_rs_siralamasi.csv', index=False, sep=';')
    print(f"\nDosya 'tüm_hisseler_rs_siralamasi.csv' olarak kaydedildi.")
